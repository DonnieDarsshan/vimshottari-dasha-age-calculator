<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vimshottari Dasha Age Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">






<style>
body{
  background: linear-gradient(180deg,#020617,#022c22,#020617);
  color:#d1fae5;
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
}

h2,h3{
  color:#facc15;
  text-shadow:0 0 6px #b45309;
}
select,input,button{
  background:#111827;
  color:#f5e9c6;
  border:1px solid #ca8a04;
  padding:6px 8px;
  margin:4px;
  border-radius:6px;
  font-weight:600;
}
button{cursor:pointer}
button:hover{background:#1f2937}
hr{border:0;border-top:1px solid #ca8a04;margin:16px 0}

.dasha-node{
  margin-left:14px;
  border-left:1px solid #7c6f3d;
  padding-left:8px;
}
.dasha-header{
  cursor:pointer;
  padding:6px 8px;
  border-radius:6px;
}


/* ==========================================
   EMERALD FOREST ‚Äî ROW VISIBILITY
   ========================================== */
.dasha-header{
  border:1px solid rgba(6,95,70,0.45); /* thin emerald line */
  background: rgba(2,44,34,0.65);      /* dark forest slab */
  transition: background 0.15s ease,
              border-color 0.15s ease,
              transform 0.12s ease;
}





/* ===== SOLID HOVER HIGHLIGHT ‚Äî ULTRA DARK NAVY ===== */
.dasha-header:hover{
  background:#020617;                 /* near black navy */
  border-color:#1e40af;               /* deep blue edge */
  box-shadow:0 0 6px rgba(30,64,175,0.35);
  transform:translateX(3px);
}







/* ===== ALIGN DASHA COLUMNS (GLOBAL FIX) ===== */
.dasha-header{
  display:grid;
  grid-template-columns: 190px 1fr;
  column-gap: 12px;
  align-items:center;
  white-space:nowrap;
}

@media (max-width: 600px){
  .dasha-header{
    grid-template-columns: 160px 1fr;
  }
}







.active > .dasha-header:hover{
  background:inherit !important;
  color:inherit !important;
}










/* ===== FINAL DASH A COLORS ‚Äî MAIN TREE ===== */

/* ===== MAHADASHA ‚Äî ANDROID SAFE ROYAL YELLOW ===== */
.active.level-1 > .dasha-header{
  background:#eab308;
  color:#000000;            /* FORCE BLACK (ANDROID SAFE) */
  border:2px solid #a16207;
  box-shadow:none;
  text-shadow:none;         /* VERY IMPORTANT */
  filter:none;              /* ANDROID SAFETY */
}



/* LEVEL 2 ‚Äî BHUKTI (DEEP CRIMSON) */
.active.level-2 > .dasha-header{
  background:#7f1d1d;
  color:#fee2e2;
  border:2px solid #dc2626;
}

/* LEVEL 3 ‚Äî ANTARA (OCEAN TEAL) */
.active.level-3 > .dasha-header{
  background:#0f766e;
  color:#ccfbf1;
  border:2px solid #2dd4bf;
}

/* LEVEL 4 ‚Äî SOOKSHMA (BURNT COPPER) */
.active.level-4 > .dasha-header{
  background:#7c2d12;
  color:#ffedd5;
  border:2px solid #ea580c;
}

/* LEVEL 5 ‚Äî PRANA (ASH PURPLE GRAY) */
.active.level-5 > .dasha-header{
  background:#312e81;
  color:#e0e7ff;
  border:2px solid #818cf8;
}










.small{font-size:13px;opacity:.9}
.age-box{
  margin-left:10px;
  font-weight:700;
  color:#4ade80;
}






/* ===== FIX SYMBOL ALIGNMENT (GLOBAL) ===== */
.dasha-header{
  grid-template-columns: 26px 190px 1fr;
}

.dasha-symbol{
  text-align:center;
  font-weight:700;
}




</style>
</head>

<body>

<h2 id="mainTitle">Vimshottari Dasha Age Calculator</h2>





<hr>
<button onclick="saveJSON()">Save (JSON)</button>
<button onclick="loadJSON()">Load </button>
<button onclick="loadSwiss()">Load Swiss </button>
<button onclick="clearAll()"> Clear All</button>

<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">

  <label>Birth Date (Pivot):</label>
  <input type="date" id="birthDate">

  <label style="font-weight:bold;margin-left:4px;">
    <input type="checkbox" id="knToggle" checked>
    KN
  </label>


 





<label>Vimshottari Anchor:</label>
<select id="anchorBody" onchange="applyAnchor()">
  <option value="Chandra" selected>Chandra</option>

  <!-- PLANETS -->
  <option value="Lagna">Lagna</option>
  <option value="Surya">Surya</option>
  <option value="Mangala">Mangala</option>
  <option value="Budha">Budha</option>
  <option value="Jupiter">Jupiter</option>
  <option value="Venus">Venus</option>
  <option value="Saturn">Saturn</option>
  <option value="Rahu">Rahu</option>
  <option value="Ketu">Ketu</option>

  <!-- CUSPS -->
  <option value="CSL2">CSL-2</option>
  <option value="CSL3">CSL-3</option>
  <option value="CSL4">CSL-4</option>
  <option value="CSL5">CSL-5</option>
  <option value="CSL6">CSL-6</option>
  <option value="CSL7">CSL-7</option>
  <option value="CSL8">CSL-8</option>
  <option value="CSL9">CSL-9</option>
  <option value="CSL10">CSL-10</option>
  <option value="CSL11">CSL-11</option>
  <option value="CSL12">CSL-12</option>
</select>


<label>Ayanamsha:</label>
<select id="ayanamsha">
  <option value="lahiri" >Lahiri</option>
  <option value="raman">Raman</option>
  <option value="kp" selected>KP (New)</option>
  
  
  <label style="margin-left:10px">
  <input type="checkbox" id="cosmeticBirthdate" checked>
  Birthdate
</label>

</select>



</div>

<!-- ================= SECOND ROW ================= -->
<div style="margin-top:10px">






  <label>Dasha Start Planet:</label>
  <select id="startPlanet">
	<option>Ketu</option><option>Venus</option><option>Surya</option>
	<option>Chandra</option><option>Mangala</option><option>Rahu</option>
	<option>Jupiter</option><option>Saturn</option><option>Budha</option>
  </select>

  <label>Dasha Start Date:</label>
  <input type="date" id="dashaStartDate">

<label>
  <input type="checkbox" id="hideDates" checked>
  Hide Dates
</label>

<label>
  <input type="checkbox" id="hideMonthDay">
  Hide Date & Month
</label>

<label>
  <input type="checkbox" id="hideAge">
  Hide Age
</label>


<label>
  <input type="checkbox" id="hideAgeMD" checked>
  Hide Age Month + Days
</label>




</div>





<div>
  <label>Show till:</label>
	<select id="showTill">
	<option value="1">Mahadasha</option>
	<option value="2" selected>Bhukti</option>
	<option value="3" >Antara</option>
	<option value="4">Sookshma</option>
	<option value="5">Prana</option>
	</select>


  <label>
	<input type="checkbox" id="repeatCycle">
	Repeat Vimshottari (2 Cycles)
  </label>

  <button onclick="generate()">Generate</button>
  <span id="nativeAge" class="age-box"></span>
</div>

<hr>
<div id="tree"></div>
<hr>

<h3>Event Analyzer</h3>


<div id="events"></div>









<hr>

<h3>Vimshottari + Yogini Dasha Comparator</h3>

<div style="margin-bottom:10px">
  <button onclick="setVYToday()">Current Transit</button>
  <input type="date" id="vyEventDate">
  <button onclick="findVYTransit()">Find</button>
  <span id="vyEventResult" class="small"></span>
</div>

<div id="vyCompareWrap" style="display:flex;gap:16px">

  <!-- VIMSHOTTARI SIDE -->
  <div class="compareBox">
    <h4 style="margin-top:0">Vimshottari</h4>

    <select id="vyVimAnchor" onchange="buildVYVimTree()">
      <option value="Lagna">Lagna</option>
      <option value="Chandra" selected>Chandra</option>
      <option>Surya</option>
      <option>Mangala</option>
      <option>Budha</option>
      <option>Jupiter</option>
      <option>Venus</option>
      <option>Saturn</option>
      <option>Rahu</option>
      <option>Ketu</option>
    </select>

    <div id="vyVimTree" class="compareTree"></div>
  </div>

  <!-- YOGINI SIDE -->
  <div class="compareBox">
    <h4 style="margin-top:0">Yogini</h4>

    <select id="vyYogAnchor" onchange="buildVYYogTree()">
      <option value="Lagna">Lagna</option>
      <option value="Chandra" selected>Chandra</option>
      <option>Surya</option>
      <option>Mangala</option>
      <option>Budha</option>
      <option>Jupiter</option>
      <option>Venus</option>
      <option>Saturn</option>
      <option>Rahu</option>
      <option>Ketu</option>
    </select>

    <div id="vyYogTree" class="compareTree yogini"></div>
  </div>

</div>





<hr>



<h3>Vimshottari Dasha Comparator</h3>

<div style="margin-bottom:8px">
  <label>
    <input type="checkbox" id="cmpHideDates" checked onchange="rebuildComparator()">
    Hide Dates
  </label>

  <label style="margin-left:12px">
    <input type="checkbox" id="cmpHideMonthDay" onchange="rebuildComparator()">
    Hide Date & Month
  </label>

  <label style="margin-left:12px">
    <input type="checkbox" id="cmpHideAge" onchange="rebuildComparator()">
    Hide Age
  </label>
</div>







<div style="margin-bottom:10px">
  <button onclick="setCmpToday()">Current Transit</button>
  <input type="date" id="cmpEventDate">
  <button onclick="findCmpTransit()">Find</button>
  <span id="cmpEventResult" class="small"></span>
</div>





<style>
#compareWrap{
  display:flex;
  gap:16px;
}
.compareBox{
  flex:1;
  border:1px solid #ca8a04;
  border-radius:8px;
  padding:10px;
  background:#0f172a;
}
.compareBox select{
  width:100%;
  margin-bottom:8px;
}
.compareTree .dasha-node{
  margin-left:12px;
  border-left:1px solid #7c6f3d;
  padding-left:8px;
}
.compareTree .dasha-header{
  cursor:pointer;
  padding:4px 6px;
  border-radius:6px;
}









/* ===== FINAL DASH A COLORS ‚Äî COMPARATOR ===== */

/* ===== COMPARATOR MAHADASHA ‚Äî ANDROID SAFE YELLOW ===== */
.compareTree .level-1.active > .dasha-header{
  background:#eab308;
  color:#000000;
  border:2px solid #a16207;
  box-shadow:none;
  text-shadow:none;
  filter:none;
}


.compareTree .level-2.active > .dasha-header{
  background:#7f1d1d;
  color:#fee2e2;
  border:2px solid #dc2626;
}

.compareTree .level-3.active > .dasha-header{
  background:#0f766e;
  color:#ccfbf1;
  border:2px solid #2dd4bf;
}

.compareTree .level-4.active > .dasha-header{
  background:#7c2d12;
  color:#ffedd5;
  border:2px solid #ea580c;
}

.compareTree .level-5.active > .dasha-header{
  background:#312e81;
  color:#e0e7ff;
  border:2px solid #818cf8;
}


















/* ===== FINAL DASH A COLORS ‚Äî YOGINI ===== */

.yogini .level-1.active > .dasha-header{
  background:#3730a3;
  color:#eef2ff;
  border:2px solid #6366f1;
  box-shadow:none;
}

.yogini .level-2.active > .dasha-header{
  background:#7f1d1d;
  color:#fee2e2;
  border:2px solid #dc2626;
}

.yogini .level-3.active > .dasha-header{
  background:#0f766e;
  color:#ccfbf1;
  border:2px solid #2dd4bf;
}

.yogini .level-4.active > .dasha-header{
  background:#7c2d12;
  color:#ffedd5;
  border:2px solid #ea580c;
}

.yogini .level-5.active > .dasha-header{
  background:#312e81;
  color:#e0e7ff;
  border:2px solid #818cf8;
}







</style>

<div id="compareWrap">

  <div class="compareBox">
	<select id="compareLeftAnchor" onchange="buildCompareTree('left')">
	  <option value="Lagna" selected>Lagna</option>
	  <option>Surya</option>
	  <option>Chandra</option>
	  <option>Mangala</option>
	  <option>Budha</option>
	  <option>Jupiter</option>
	  <option>Venus</option>
	  <option>Saturn</option>
	  <option>Rahu</option>
	  <option>Ketu</option>
	</select>
	<div id="compareLeftTree" class="compareTree"></div>
  </div>

  <div class="compareBox">
	<select id="compareRightAnchor" onchange="buildCompareTree('right')">
	  <option>Lagna</option>
	  <option>Surya</option>
	  <option value="Chandra" selected>Chandra</option>
	  <option>Mangala</option>
	  <option>Budha</option>
	  <option>Jupiter</option>
	  <option>Venus</option>
	  <option>Saturn</option>
	  <option>Rahu</option>
	  <option>Ketu</option>
	</select>
	<div id="compareRightTree" class="compareTree"></div>
  </div>

</div>









<hr>

<h3>Yogini Dasha Analyzer</h3>




<div style="margin-bottom:10px">

  <button onclick="setYoginiAnalyzerToday()">Current Transit</button>

  <input type="date" id="yoginiAnalyzerDate">

  <button onclick="findYoginiAnalyzer()">Find</button>

  <label style="margin-left:12px">
    <input type="checkbox" id="yogHideDates" checked onchange="buildYogini()">
    Hide Dates
  </label>

  <label>
    <input type="checkbox" id="yogHideMonthDay" onchange="buildYogini()">
    Hide Date & Month
  </label>

  <label>
    <input type="checkbox" id="yogHideAge" onchange="buildYogini()">
    Hide Age
  </label>

  <label>
    <input type="checkbox" id="yogHideAgeMD" checked onchange="buildYogini()">
    Hide Age Month + Days
  </label>

  
</div>




<div style="margin-bottom:10px">




<label>Yogini Show Till:</label>
<select id="yoginiShowTill" onchange="buildYogini()">
  <option value="1">Yogini Dasha</option>
  <option value="2" selected>Bhukti</option>
  <option value="3">Antara</option>
  <option value="4">Sookshma</option>
  <option value="5">Prana</option>
</select>







  <label>Yogini Pivot:</label>
  
  <select id="yoginiPivot" onchange="buildYogini()">
  <!-- PLANETS -->
  <option value="Chandra" selected>Chandra</option>
  <option value="Lagna">Lagna</option>
  <option value="Surya">Surya</option>
  <option value="Mangala">Mangala</option>
  <option value="Budha">Budha</option>
  <option value="Jupiter">Jupiter</option>
  <option value="Venus">Venus</option>
  <option value="Saturn">Saturn</option>
  <option value="Rahu">Rahu</option>
  <option value="Ketu">Ketu</option>

  <!-- CUSPS (REAL SWISS CSL) -->
  <option value="CSL1">CSL-1</option>
  <option value="CSL2">CSL-2</option>
  <option value="CSL3">CSL-3</option>
  <option value="CSL4">CSL-4</option>
  <option value="CSL5">CSL-5</option>
  <option value="CSL6">CSL-6</option>
  <option value="CSL7">CSL-7</option>
  <option value="CSL8">CSL-8</option>
  <option value="CSL9">CSL-9</option>
  <option value="CSL10">CSL-10</option>
  <option value="CSL11">CSL-11</option>
  <option value="CSL12">CSL-12</option>
</select>


</div>





<div id="yoginiTree"></div>

















<hr>

<h3>Yogini Dasha Comparator</h3>










<div style="margin-bottom:10px">
  <button onclick="setYoginiCmpToday()">Current Transit</button>

  <input type="date" id="yogCmpEventDate">

  <button onclick="findYoginiCmpTransit()">Find</button>

  <label style="margin-left:12px">
    <input type="checkbox" id="yogCmpHideDates" checked onchange="rebuildYoginiComparator()">
    Hide Dates
  </label>

  <label>
    <input type="checkbox" id="yogCmpHideMonthDay" onchange="rebuildYoginiComparator()">
    Hide Date & Month
  </label>

  <label>
    <input type="checkbox" id="yogCmpHideAge" onchange="rebuildYoginiComparator()">
    Hide Age
  </label>
</div>














<div id="yogCompareWrap" style="display:flex;gap:16px">

  <div class="compareBox">
    <select id="yogCompareLeftAnchor" onchange="rebuildYoginiComparator()">
	  <option value="Lagna" selected>Lagna</option>
	  <option>Surya</option>
	  <option>Chandra</option>
	  <option>Mangala</option>
	  <option>Budha</option>
	  <option>Jupiter</option>
	  <option>Venus</option>
	  <option>Saturn</option>
	  <option>Rahu</option>
	  <option>Ketu</option>
	</select>

    <div id="yogCompareLeft" class="compareTree yogini"></div>
  </div>
  

 

  <div class="compareBox">
    <select id="yogCompareRightAnchor" onchange="rebuildYoginiComparator()">
	  <option>Lagna</option>
	  <option>Surya</option>
	  <option value="Chandra" selected>Chandra</option>
	  <option>Mangala</option>
	  <option>Budha</option>
	  <option>Jupiter</option>
	  <option>Venus</option>
	  <option>Saturn</option>
	  <option>Rahu</option>
	  <option>Ketu</option>
	</select>

    <div id="yogCompareRight" class="compareTree yogini"></div>
  </div>

</div>














<script>
const ORDER=["Ketu","Venus","Surya","Chandra","Mangala","Rahu","Jupiter","Saturn","Budha"];
const YEARS={Ketu:7,Venus:20,Surya:6,Chandra:10,Mangala:7,Rahu:18,Jupiter:16,Saturn:19,Budha:17};

const LEVELS=["Mahadasha","Bhukti","Antara","Sookshma","Prana"];

/* =================================================
   LANGUAGE SYSTEM (ENGLISH ‚Üî KANNADA)
   ================================================= */

let USE_KANNADA = false;

const KN = {

  /* DASHAS */
  Mahadasha:"‡≤Æ‡≤π‡≤æ‡≤¶‡≤∂‡≥Ü",
  Bhukti:"‡≤≠‡≥Å‡≤ï‡≥ç‡≤§‡≤ø",
  Antara:"‡≤Ö‡≤Ç‡≤§‡≤∞ ‡≤≠‡≥Å‡≤ï‡≥ç‡≤§‡≤ø",
  Sookshma:"‡≤∏‡≥Ç‡≤ï‡≥ç‡≤∑‡≥ç‡≤Æ",
  Prana:"‡≤™‡≥ç‡≤∞‡≤æ‡≤£",

  /* TITLES */
  "Vimshottari Dasha":"‡≤µ‡≤ø‡≤Ç‡≤∂‡≥ã‡≤§‡≥ç‡≤§‡≤∞‡≤ø ‡≤¶‡≤∂",
  "Yogini Dasha":"‡≤Ø‡≥ã‡≤ó‡≤ø‡≤®‡≤ø ‡≤¶‡≤∂",

  /* YOGINI */
  Mangala:"‡≤Æ‡≤Ç‡≤ó‡≤≥",
  Pingala:"‡≤™‡≤ø‡≤Ç‡≤ó‡≤≥",
  Dhanya:"‡≤ß‡≤®‡≥ç‡≤Ø‡≤æ",
  Bhramari:"‡≤≠‡≥ç‡≤∞‡≤Æ‡≤∞‡≤ø",
  Bhadrika:"‡≤≠‡≤¶‡≥ç‡≤∞‡≤ø‡≤ï",
  Ulka:"‡≤â‡≤≤‡≥ç‡≤ï‡≤æ",
  Sidda:"‡≤∏‡≤ø‡≤¶‡≥ç‡≤¶",
  Sankata:"‡≤∏‡≤Ç‡≤ï‡≤ü",
  RahuKetu:"‡≤∞‡≤æ‡≤π‡≥Å + ‡≤ï‡≥á‡≤§‡≥Å",


  /* PLANETS */
  Surya:"‡≤∏‡≥Ç‡≤∞‡≥ç‡≤Ø",
  Chandra:"‡≤ö‡≤Ç‡≤¶‡≥ç‡≤∞",
  MangalaPlanet:"‡≤Æ‡≤Ç‡≤ó‡≤≥",
  Rahu:"‡≤∞‡≤æ‡≤π‡≥Å",
  
  Jupiter:"‡≤ó‡≥Å‡≤∞‡≥Å",
  Saturn:"‡≤∂‡≤®‡≤ø",
  Budha:"‡≤¨‡≥Å‡≤ß",
  Ketu:"‡≤ï‡≥á‡≤§‡≥Å",
  Venus:"‡≤∂‡≥Å‡≤ï‡≥ç‡≤∞",

  years:"‡≤µ‡≤∞‡≥ç‡≤∑"
};

function T(txt){
  if(!USE_KANNADA) return txt;

  if(txt==="Rahu+Ketu") return KN.RahuKetu;

  if(KN[txt]) return KN[txt];

  if(txt==="Mangala") return KN.MangalaPlanet;

  return txt;
}










const LEVEL_SYMBOL = {
  1: "‚≠ê",
  2: "‚ñ∂",
  3: "‚óÜ",
  4: "¬ª",
  5: "‚Ä¢"
};

function isTodayInRange(start, end){
  const today = new Date();
  today.setHours(0,0,0,0);
  return today >= new Date(start) && today < new Date(end);
}

function levelPrefix(level, start, end){
  return isTodayInRange(start, end)
    ? `<span class="dasha-symbol">${LEVEL_SYMBOL[level]}</span>`
    : `<span class="dasha-symbol"></span>`;
}

const MS_YEAR = 365.25*24*60*60*1000;



// =================================================
// YOGINI DASHA ‚Äî CONSTANT ORDER (MUST BE EARLY)
// =================================================
const YOGINI_ORDER = [
  { name:"Mangala", lord:"Chandra", years:1 },
  { name:"Pingala", lord:"Surya", years:2 },
  { name:"Dhanya", lord:"Jupiter", years:3 },
  { name:"Bhramari", lord:"Mangala", years:4 },
  { name:"Bhadrika", lord:"Budha", years:5 },
  { name:"Ulka", lord:"Saturn", years:6 },
  { name:"Sidda", lord:"Venus", years:7 },
  { name:"Sankata", lord:"Rahu+Ketu", years:8 }
];




let lastExpanded=false;

let COSMETIC_BIRTHDATE =
  document.getElementById("cosmeticBirthdate")?.checked || false;

// ===============================
// GLOBAL SWISS JSON STORAGE
// ===============================
let SWISS_DATA = null; // holds full Swiss ephemeris JSON


/* ===== CORE FUNCTIONS (UNCHANGED) ===== */
function addYears(d,y){return new Date(d.getTime()+y*MS_YEAR)}
function rotate(p){let i=ORDER.indexOf(p);return ORDER.slice(i).concat(ORDER.slice(0,i))}









/* =========================================
   GLOBAL CURRENT TRANSIT DATE FIX (FINAL)
   ========================================= */

function fillAllCurrentTransitDates(){
  const today = new Date().toISOString().slice(0,10);

  const ids = [
  "ed0",                 // Main Event Analyzer
  "cmpEventDate",        // Vimshottari Comparator
  "vyEventDate",         // ‚úÖ Vimshottari + Yogini Comparator
  "yoginiAnalyzerDate",  // Yogini Analyzer
  "yogCmpEventDate"      // Yogini Comparator
];



  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el && !el.value){
      el.value = today;
    }
  });
}





document.getElementById("cosmeticBirthdate").onchange = () => {
  COSMETIC_BIRTHDATE = document.getElementById("cosmeticBirthdate").checked;
  autoRefreshAll();
};





function diffYMD(from,to){
  if(!from || to < from) return "";

  if(document.getElementById("hideAge")?.checked){
    return "";
  }

  let d = to - from;
  let y = Math.floor(d / MS_YEAR);

  if(document.getElementById("hideAgeMD")?.checked){
    return `${y} ${T("years")}`;
  }

  d -= y * MS_YEAR;
  let m = Math.floor(d / (30.4375*24*60*60*1000));
  let da = Math.floor((d % (30.4375*24*60*60*1000))/(24*60*60*1000));

  return `${y} ${T("years")} ${m} months ${da} days`;
}












function diffYMD_YOGINI(from, to){
  if(!from || to < from) return "";

  if(document.getElementById("yogHideAge")?.checked){
    return "";
  }

  let d = to - from;
  let y = Math.floor(d / MS_YEAR);

  if(document.getElementById("yogHideAgeMD")?.checked){
    return `${y} ${T("years")}`;
  }

  d -= y * MS_YEAR;
  let m = Math.floor(d / (30.4375*24*60*60*1000));
  let da = Math.floor((d % (30.4375*24*60*60*1000))/(24*60*60*1000));

  return `${y} ${T("years")} ${m} months ${da} days`;
}










function cosmeticAgeZero(){
  if(document.getElementById("hideAge")?.checked){
    return "";
  }

  if(document.getElementById("hideAgeMD")?.checked){
    return ` (0 ${T("years")})`;
  }

  return ` (0 ${T("years")} 0 months 0 days)`;
}






function cosmeticStartDate(d){
  if(
    COSMETIC_BIRTHDATE &&
    birthDate.value &&
    d < new Date(birthDate.value)
  ){
    return new Date(birthDate.value);
  }
  return d;
}












/* ===== AGE OF NATIVE ===== */
function updateNativeAge(){
  if(!birthDate.value){
	nativeAge.textContent="";
	return;
  }
  let today=new Date();
  nativeAge.textContent="Age of Native : "+diffYMD(new Date(birthDate.value), today);
}

function genLevel(level,start,planet,yrs,max){
  if(level>max)return[];
  let arr=[],cur=new Date(start);
  rotate(planet).forEach(p=>{
	let y=yrs*(YEARS[p]/120);
	let end=addYears(cur,y);
	arr.push({level,planet:p,start:new Date(cur),end:new Date(end),
	  children:genLevel(level+1,cur,p,y,max)});
	cur=end;
  });
  return arr;
}










function generate(){
  tree.innerHTML="";
  updateNativeAge();
  if(!birthDate.value) return;

  if(!dashaStartDate.value){
    dashaStartDate.value = birthDate.value;
  }

  let max = +showTill.value;
  let cycles = repeatCycle.checked ? 2 : 1;
  let cur = new Date(dashaStartDate.value);

  for(let c=0;c<cycles;c++){
    rotate(startPlanet.value).forEach(p=>{
      let end = addYears(cur, YEARS[p]);

      tree.appendChild(render({
        level:1,
        planet:p,
        start:new Date(cur),
        end:new Date(end),
        children:genLevel(2,cur,p,YEARS[p],max)
      }));

      cur = end;
    });
  }

  setManualMode(true);

  /* ===============================
     üî• CRITICAL FIX (THE REAL ONE)
     Build Vimshottari + Yogini HERE
     =============================== */
  if(BODY_DEGREE_MAP){
    buildVYVimTree();
    buildVYYogTree();
  }
}














function render(n){
  let w=document.createElement("div");
  w.className="dasha-node level-"+n.level;
  w.dataset.s=n.start;w.dataset.e=n.end;w.dataset.l=n.level;

  let h=document.createElement("div");
  h.className="dasha-header";
  let hideDates = document.getElementById("hideDates")?.checked;
  let hideMonthDay = document.getElementById("hideMonthDay")?.checked;
  let hideAge = document.getElementById("hideAge")?.checked;




  function formatDate(d){

  // Hide Date & Month ‚Üí YEAR ONLY
  if(hideMonthDay){
	return d.getFullYear();
  }

  // Hide Date ‚Üí YEAR + MONTH (no day)
  if(hideDates){
	return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
  }

  // Default ‚Üí FULL DATE
  return d.toISOString().slice(0,10);
}




  let startDate = formatDate(n.start);

  if(
    COSMETIC_BIRTHDATE &&
    n.level === 1 &&
    birthDate.value &&
    new Date(n.start) < new Date(birthDate.value)
  ){
    startDate = formatDate(new Date(birthDate.value));
  }


  let endDate = formatDate(n.end);

  let ageStart = hideAge ? "" : ` (Age ${diffYMD(new Date(birthDate.value),n.start)})`;

  if(
    COSMETIC_BIRTHDATE &&
    n.level === 1 &&
    birthDate.value &&
    new Date(n.start) < new Date(birthDate.value)
  ){
    ageStart = cosmeticAgeZero();
  }


  let ageEnd   = hideAge ? "" : ` (Age ${diffYMD(new Date(birthDate.value),n.end)})`;

  h.innerHTML =
  `${levelPrefix(n.level,n.start,n.end)}` +
  `<b>${T(LEVELS[n.level-1])} ‚Äì ${T(n.planet)}</b> | ` +
  `${startDate}${ageStart} ‚Üí‚Üí‚Üí‚Üí ${endDate}${ageEnd}`;



  let c=document.createElement("div");c.style.display="none";
  n.children.forEach(ch=>c.appendChild(render(ch)));

  h.onclick=()=>{
	w.classList.toggle("active");
	c.style.display=w.classList.contains("active")?"block":"none";
  };

  w.appendChild(h);w.appendChild(c);return w;
}

/* ===== EVENTS ===== */
function buildEvents(){
  let today=new Date().toISOString().slice(0,10);
  let html=`
  <div>
	<button onclick="setToday()">Current Transit</button>
	<input type="date" id="ed0" value="${today}">
	<button onclick="findEvent(0)">Find</button>
	<span id="er0" class="small"></span>
  </div>`;
  for(let i=1;i<=5;i++){
	html+=`
	<div>
	  <input id="en${i}" placeholder="Event name">
	  <input type="date" id="ed${i}">
	  <button onclick="findEvent(${i})">Find</button>
	  <span id="er${i}" class="small"></span>
	</div>`;
  }
  events.innerHTML=html;
}
buildEvents();

["hideDates","hideMonthDay","hideAge","hideAgeMD"].forEach(id=>{
  document.getElementById(id).onchange = ()=>{
	if(tree.innerHTML.trim()){
	  generate();
	}
  };
});





showTill.onchange = () => {
  if(tree.innerHTML.trim()){
    generate();
    rebuildComparator();
  }
};



setToday();

function setToday(){
  document.getElementById("ed0").value=new Date().toISOString().slice(0,10);
}







function findEvent(i){

  let r = document.getElementById(`er${i}`);

  // üîí ISOLATED TO MAIN VIMSHOTTARI TREE ONLY
  const scope = document.getElementById("tree");

  if(lastExpanded){
    scope.querySelectorAll(".active").forEach(a=>a.classList.remove("active"));
    scope.querySelectorAll(".dasha-node > div:nth-child(2)")
      .forEach(d=>d.style.display="none");
    r.textContent="";
    lastExpanded=false;
    return;
  }

  let d = new Date(document.getElementById(`ed${i}`).value);

  let nodes = [...scope.querySelectorAll(".dasha-node")]
    .filter(n =>
      d >= new Date(n.dataset.s) &&
      d <  new Date(n.dataset.e)
    )
    .sort((a,b)=>a.dataset.l - b.dataset.l);

  nodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  r.textContent =
    nodes.map(n=>n.querySelector("b").textContent.split(" ‚Äì ").pop())
         .join(" ‚Äì ");

  lastExpanded = true;
}










/* ===== CLEAR ===== */
function clearAll(){

  tree.innerHTML="";
  document.querySelectorAll(".active").forEach(a=>a.classList.remove("active"));
  document.querySelectorAll(".small").forEach(s=>s.textContent="");
  document.querySelectorAll("input").forEach(i=>i.value="");
  nativeAge.textContent="";
  lastExpanded=false;
}

/* ===== SAVE / LOAD (EVENTS INCLUDED) ===== */
function saveJSON(){
  let eventsData=[];
  for(let i=0;i<=5;i++){
	eventsData.push({
	  name:document.getElementById(`en${i}`)?.value||"",
	  date:document.getElementById(`ed${i}`)?.value||""
	});
  }
  let data={
	birthDate:birthDate.value,
	startPlanet:startPlanet.value,
	dashaStartDate:dashaStartDate.value,
	showTill:showTill.value,
	repeatCycle:repeatCycle.checked,
	events:eventsData
  };
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}));
  a.download="vimshottari.json";
  a.click();
}

function loadJSON(){
  let i=document.createElement("input");
  i.type="file";i.accept="application/json";
  i.onchange=e=>{
	let r=new FileReader();
	r.onload=()=>{
	  let d=JSON.parse(r.result);
	  birthDate.value=d.birthDate;
	  startPlanet.value=d.startPlanet;
	  dashaStartDate.value=d.dashaStartDate;
	  showTill.value=d.showTill;
	  repeatCycle.checked=d.repeatCycle;
	  generate();
	  if(d.events){
		d.events.forEach((ev,i)=>{
		  if(document.getElementById(`en${i}`))document.getElementById(`en${i}`).value=ev.name;
		  if(document.getElementById(`ed${i}`))document.getElementById(`ed${i}`).value=ev.date;
		});
	  }
	};
	r.readAsText(e.target.files[0]);
  };
  i.click();
}












</script>









<script>












</script>











<script>
/* =====================================================
   SWISS EPHEMERIS ‚Äì CORRECT ORDER
   ===================================================== */

/* --- DEGREE NORMALIZER --- */
function normalizeDeg(deg){
  return ((deg % 360) + 360) % 360;
}



/* ===== AYANAMSHA NAME MAP ===== */
// Maps dropdown value ‚Üí JSON key
const AYANAMSHA_JSON_KEY = {
  lahiri: "Lahiri",
  raman: "Raman",
  kp: "KP New"
};



/* --- SWISS JSON LOADER --- */
function loadSwiss(){

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {

	const reader = new FileReader();

	reader.onload = () => {

	const data = JSON.parse(reader.result);   // ‚úÖ THIS LINE WAS MISSING
	SWISS_DATA = data;


		// Set birth date
		if(SWISS_DATA.meta?.datetime_utc){
		  birthDate.value = SWISS_DATA.meta.datetime_utc.slice(0,10);
		}

		// Load degrees for selected ayanamsha
		loadAyanamshaFromSwiss();

		// Apply anchor if selected
		if(anchorBody.value){
		  applyAnchor();
		}else{
		  setManualMode(true);
		}

		// Build dasha tree
		generate();
		rebuildComparator();
		updateNativeAge();
		buildYogini();
		rebuildYoginiComparator();




			  
	  
	  
	  
	  
	  
	};

	reader.readAsText(e.target.files[0]);
  };

  input.click();
}






</script>

















<script>



// ==================================================
// AYANAMSHA ‚Üí DEGREE LOADER (FROM SWISS JSON)
// ==================================================





function loadAyanamshaFromSwiss(){

  if(!SWISS_DATA) return;

  const ayaKey = AYANAMSHA_JSON_KEY[ayanamsha.value];
  const ayaBlock = SWISS_DATA.ayanamshas?.[ayaKey];

  if(!ayaBlock){
    alert("Ayanamsha data not found in Swiss JSON");
    return;
  }

  // Reset degree maps
  RAW_DEGREE_MAP = {};
  BODY_DEGREE_MAP = {};

  // Lagna
  RAW_DEGREE_MAP.Lagna = normalizeDeg(ayaBlock.lagna);

  // Planets
  for(const p in ayaBlock.planets){
    if(ORDER.includes(p)){
      RAW_DEGREE_MAP[p] = normalizeDeg(ayaBlock.planets[p]);
    }
  }

  // Direct usage (NO OFFSETS)
  BODY_DEGREE_MAP = { ...RAW_DEGREE_MAP };
  
  
  // ===============================
  // LOAD PLANETS + LAGNA
  // ===============================
  BODY_DEGREE_MAP = { ...RAW_DEGREE_MAP };

  // ===============================
  // LOAD REAL HOUSE CUSPS (CSL)
  // FROM SELECTED AYANAMSHA BLOCK
  // ===============================
  const cuspBlock = ayaBlock.cusps;

  if(cuspBlock){
    for(let i = 1; i <= 12; i++){
      const deg = cuspBlock[String(i)];
      if(deg != null){
        BODY_DEGREE_MAP["CSL" + i] = normalizeDeg(deg);
      }
    }
  }
}




















/* ===== VIMSHOTTARI ANCHOR LOGIC ===== */

let RAW_DEGREE_MAP = {};    // original Swiss (base Lahiri)
let BODY_DEGREE_MAP = {};  // ayanamsha-adjusted working map



function setManualMode(isManual){
  startPlanet.disabled = !isManual;
  dashaStartDate.disabled = !isManual;

  startPlanet.style.opacity = isManual ? "1" : "0.6";
  dashaStartDate.style.opacity = isManual ? "1" : "0.6";
}


function nakIndex(deg){
  return Math.floor(deg / 13.3333333333);
}

function nakLord(deg){
  return ORDER[nakIndex(deg) % 9];
}

function dashaElapsedYears(deg){
  let frac = (deg % 13.3333333333) / 13.3333333333;
  let lord = nakLord(deg);
  return YEARS[lord] * frac;
}


function applyAnchor(){

  /* MANUAL MODE */
  if(!anchorBody.value){
	setManualMode(true);
	return;
  }

  /* AUTO MODE */
  if(!birthDate.value) return;
  setManualMode(false);

  let deg = BODY_DEGREE_MAP[anchorBody.value];

  if(deg == null) return;

  let lord = nakLord(deg);
  startPlanet.value = lord;

let elapsedYears = dashaElapsedYears(deg);
let start = new Date(birthDate.value);
start = new Date(start.getTime() - elapsedYears * MS_YEAR);
dashaStartDate.value = start.toISOString().slice(0,10);
updateNativeAge();


  // üîÅ AUTO REFRESH AFTER ANCHOR RECALCULATION
  generate();
  rebuildComparator();
  buildYogini();
  rebuildYoginiComparator();



}
















// ============================================
// AYANAMSHA CHANGE ‚Üí RELOAD FROM STORED JSON
// ============================================
ayanamsha.onchange = () => {

  if(!SWISS_DATA) return;

  tree.innerHTML = "";

  loadAyanamshaFromSwiss();

  if(anchorBody.value){
    applyAnchor(); // ‚Üê this will auto-generate
  }else{
    generate();
    rebuildComparator();
    buildYogini();
    rebuildYoginiComparator();
	autoRefreshAll(); // ‚Üê THIS IS WHAT WAS MISSING

	
	
	
	

	
	
	
	
	
	// üîÅ build combined comparator with Chandra defaults
	if(vyVimAnchor) vyVimAnchor.value = "Chandra";
	if(vyYogAnchor) vyYogAnchor.value = "Chandra";

	
	fillAllCurrentTransitDates();

  }

  updateNativeAge();
};



</script>










<script>























function genCompareLevel(level,start,planet,yrs,max){
if(level > max || max < 1) return [];

  let arr=[],cur=new Date(start);

  rotate(planet).forEach(p=>{
	let y = yrs * (YEARS[p]/120);
	let end = addYears(cur,y);

	arr.push({
	  level,
	  planet:p,
	  start:new Date(cur),
	  end:new Date(end),
	  children:genCompareLevel(level+1,cur,p,y,max)
	});

	cur = end;
  });

  return arr;
}






function renderCompareNode(n){

  let w = document.createElement("div");
  w.className = "dasha-node level-" + n.level;

  w.dataset.s = n.start;
  w.dataset.e = n.end;
  w.dataset.l = n.level;

  let h = document.createElement("div");
  h.className = "dasha-header";










function fmtCmpDate(d){

  d = cosmeticStartDate(d);

  if(document.getElementById("cmpHideMonthDay")?.checked){
    return d.getFullYear();
  }
  if(document.getElementById("cmpHideDates")?.checked){
    return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
  }
  return d.toISOString().slice(0,10);
}





  let startAge = "";
let endAge   = "";

if(
  COSMETIC_BIRTHDATE &&
  n.level === 1 &&
  birthDate.value &&
  n.start < new Date(birthDate.value)
){
  startAge = cosmeticAgeZero().replace("Age ","");
}
else if(!document.getElementById("cmpHideAge")?.checked){
  const birth = new Date(birthDate.value);
  startAge = ` (${Math.floor((n.start - birth) / MS_YEAR)} ${T("years")})`;
}

if(!document.getElementById("cmpHideAge")?.checked){
  const birth = new Date(birthDate.value);
  endAge = ` (${Math.floor((n.end - birth) / MS_YEAR)} ${T("years")})`;
}








  h.innerHTML =
  `${levelPrefix(n.level,n.start,n.end)}` +
  `<b>${T(LEVELS[n.level-1])} ‚Äì ${T(n.planet)}</b> | ` +
  `${fmtCmpDate(n.start)}${startAge} ‚Üí ${fmtCmpDate(n.end)}${endAge}`;


  let c = document.createElement("div");
  c.style.display = "none";
  n.children.forEach(ch => c.appendChild(renderCompareNode(ch)));

  h.onclick = () => {
    w.classList.toggle("active");
    c.style.display = w.classList.contains("active") ? "block" : "none";
  };

  w.appendChild(h);
  w.appendChild(c);
  return w;
}







function buildCompareTree(side){

  const anchor =
    side === "left"
      ? compareLeftAnchor.value
      : compareRightAnchor.value;

  const target =
    side === "left"
      ? compareLeftTree
      : compareRightTree;

  if(!birthDate.value || !BODY_DEGREE_MAP[anchor]) return;

  target.innerHTML = "";

  let deg = BODY_DEGREE_MAP[anchor];
  let lord = nakLord(deg);
  let elapsed = dashaElapsedYears(deg);

  let start = new Date(birthDate.value);
  start = new Date(start.getTime() - elapsed * MS_YEAR);

  rotate(lord).forEach(p=>{
    let end = addYears(start, YEARS[p]);

    target.appendChild(
      renderCompareNode({
        level:1,
        planet:p,
        start:new Date(start),
        end:new Date(end),
        children:genCompareLevel(2,start,p,YEARS[p],+showTill.value)
      })
    );

    start = end;
  });
}














function rebuildComparator(){
  buildCompareTree("left");
  buildCompareTree("right");
}


</script>



<script>


/* =========================================
   VIMSHOTTARI COMPARATOR ‚Äî TRANSIT FINDER
   ========================================= */

function setCmpToday(){
  document.getElementById("cmpEventDate").value =
    new Date().toISOString().slice(0,10);
}

function findCmpTransit(){

  const dval = cmpEventDate.value;
  if(!dval) return;
  const d = new Date(dval);

  document.querySelectorAll("#compareWrap .active")
    .forEach(n=>n.classList.remove("active"));

  document.querySelectorAll("#compareWrap .dasha-node > div:nth-child(2)")
    .forEach(n=>n.style.display="none");

  const nodes = [...document.querySelectorAll("#compareWrap .dasha-node")]
    .filter(n =>
      d >= new Date(n.dataset.s) &&
      d <  new Date(n.dataset.e)
    )
    .sort((a,b)=>a.dataset.l-b.dataset.l);

  nodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  cmpEventResult.textContent =
    nodes.map(n=>n.querySelector("b").textContent.split(" ‚Äì ").pop())
         .join(" ‚Üí ");
}
</script>







</script>




<script>
/* =========================================
   YOGINI COMPARATOR (LAGNA vs CHANDRA)
   ========================================= */

function rebuildYoginiComparator(){
  buildYoginiCompare(
    yogCompareLeftAnchor.value,
    yogCompareLeft
  );
  buildYoginiCompare(
    yogCompareRightAnchor.value,
    yogCompareRight
  );
}


function buildYoginiCompare(anchor, target){

  if(!birthDate.value) return;
  if(!BODY_DEGREE_MAP[anchor]) return;

  target.innerHTML = "";

  let deg = BODY_DEGREE_MAP[anchor];
  let nak = Math.floor(deg / 13.3333333333) + 1;
  let idx = (nak + 3) % 8;
  if(idx === 0) idx = 8;
  idx--;

  let birth = new Date(birthDate.value);
  let first = YOGINI_ORDER[idx];

  let nakStart = (nak - 1) * 13.3333333333;
  let elapsedDeg = deg - nakStart;
  if(elapsedDeg < 0) elapsedDeg += 360;

  let elapsedYears = (elapsedDeg / 13.3333333333) * first.years;
  let cur = new Date(birth.getTime() - elapsedYears * MS_YEAR);

  for(let cycle=0; cycle<3; cycle++){
    for(let i=0;i<8;i++){
      let y = YOGINI_ORDER[(idx + i) % 8];
      let end = addYears(cur, y.years);

      target.appendChild(
        renderYoginiCompareNode({
          level:1,
          name:y.name,
          lord:y.lord,
          start:new Date(cur),
          end:new Date(end),
          years:y.years,
          children:genYoginiCompareLevel(2,cur,y,y.years)
        })
      );

      cur = end;
    }
  }
}


























birthDate.addEventListener("change", autoRefreshAll);

setCmpToday();


document.addEventListener("DOMContentLoaded", () => {
  const cb = document.getElementById("cosmeticBirthdate");
  if(cb){
    COSMETIC_BIRTHDATE = cb.checked;
  }
});







function setYoginiCmpToday(){
  document.getElementById("yogCmpEventDate").value =
    new Date().toISOString().slice(0,10);
}

function findYoginiCmpTransit(){

    const val = document.getElementById("yogCmpEventDate").value;
  if(!val) return;

  const d = new Date(val);

  // clear previous
  document
    .querySelectorAll("#yogCompareWrap .active")
    .forEach(a=>a.classList.remove("active"));

  document
    .querySelectorAll("#yogCompareWrap .dasha-node > div:nth-child(2)")
    .forEach(d=>d.style.display="none");

  // find matching yogini nodes
  const nodes = [...document.querySelectorAll("#yogCompareWrap .dasha-node")]
    .filter(n =>
      d >= new Date(n.dataset.s) &&
      d <  new Date(n.dataset.e)
    )
    .sort((a,b)=>a.dataset.l - b.dataset.l);

  nodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  
}

// auto-fill today
setYoginiCmpToday();





</script>




















<script>











function nakshatraStartDegree(nakNumber){
  // Nakshatra 1 (Ashwini) starts at 0¬∞
  return (nakNumber - 1) * 13.3333333333;
}



function buildYogini(){

  yoginiTree.innerHTML = "";
  if(!birthDate.value) return;

  let deg = BODY_DEGREE_MAP[yoginiPivot.value];
  if(deg == null) return;

  // Nakshatra index: Ashwini = 1
  let nak = Math.floor(deg / 13.3333333333) + 1;

  // Yogini index (classical)
  let yoginiIndex = (nak + 3) % 8;
if(yoginiIndex === 0) yoginiIndex = 8;
yoginiIndex = yoginiIndex - 1; // convert to 0-based index


  let birth = new Date(birthDate.value);


let first = YOGINI_ORDER[yoginiIndex];







// -------------------------------
// NAKSHATRA-LEVEL BHOGYA (FINAL & CORRECT)
// -------------------------------

// degrees elapsed in nakshatra
let nakStart = nakshatraStartDegree(nak);
let nakDeg = deg - nakStart;
if(nakDeg < 0) nakDeg += 360;

// elapsed degrees in nakshatra
let elapsedDeg = nakDeg;

// elapsed Yogini years at birth (BHUKTA)
let elapsedYears =
  (elapsedDeg / 13.3333333333) * first.years;






  // real start of first Yogini
  let cur = new Date(birth.getTime() - elapsedYears * MS_YEAR);

  let maxLevel = +yoginiShowTill.value;

  // 108 years = 3 full cycles
  for(let cycle=0; cycle<3; cycle++){
    for(let i=0;i<8;i++){
      let y = YOGINI_ORDER[(yoginiIndex + i) % 8];
      let end = addYears(cur, y.years);

      yoginiTree.appendChild(
        renderYoginiNode({
          level:1,
          name:y.name,
          lord:y.lord,
          start:new Date(cur),
          end:new Date(end),
          years:y.years,
          children:genYoginiLevel(2,cur,y,y.years,maxLevel)
        })
      );

      cur = end;
    }
  }
}




















document.addEventListener("DOMContentLoaded", ()=>{

  fillAllCurrentTransitDates();

  const kn = document.getElementById("knToggle");

  if(kn){

    /* ===== APPLY DEFAULT STATE ===== */
    USE_KANNADA = kn.checked;

    const title = document.getElementById("mainTitle");
    if(title){
      title.textContent = USE_KANNADA
        ? "‡≤µ‡≤ø‡≤Ç‡≤∂‡≥ã‡≤§‡≥ç‡≤§‡≤∞‡≤ø ‡≤¶‡≤∂ ‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å ‡≤ó‡≤£‡≤ï"
        : "Vimshottari Dasha Age Calculator";
    }

    /* ===== CHANGE HANDLER ===== */
    kn.addEventListener("change", ()=>{

      USE_KANNADA = kn.checked;

      if(title){
        title.textContent = USE_KANNADA
          ? "‡≤µ‡≤ø‡≤Ç‡≤∂‡≥ã‡≤§‡≥ç‡≤§‡≤∞‡≤ø ‡≤¶‡≤∂ ‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å ‡≤ó‡≤£‡≤ï"
          : "Vimshottari Dasha Age Calculator";
      }

      document.body.style.display="none";
      document.body.offsetHeight;
      document.body.style.display="";

      autoRefreshAll();
    });
  }

});




function setYoginiAnalyzerToday(){
  document.getElementById("yoginiAnalyzerDate").value =
    new Date().toISOString().slice(0,10);
}








function genYoginiLevel(level,start,yogini,yrs,max){
  if(level > max) return [];

  let arr = [];
  let cur = new Date(start);

  // ‚úÖ rotate from CURRENT yogini, not Mangala
  const startIndex = YOGINI_ORDER.findIndex(y => y.name === yogini.name);
  const rotated = [
    ...YOGINI_ORDER.slice(startIndex),
    ...YOGINI_ORDER.slice(0, startIndex)
  ];

  rotated.forEach(y => {
    let ylen = yrs * (y.years / 36);
    let end = addYears(cur, ylen);

    arr.push({
      level,
      name: y.name,
      lord: y.lord,
      start: new Date(cur),
      end: new Date(end),
      years: ylen,
      children: genYoginiLevel(level + 1, cur, y, ylen, max)
    });

    cur = end;
  });

  return arr;
}











function renderYoginiNode(n){

  let w = document.createElement("div");
  w.className = "dasha-node yogini level-" + n.level;

  w.dataset.s = n.start;
  w.dataset.e = n.end;
  w.dataset.l = n.level;

  let h = document.createElement("div");
  h.className = "dasha-header";

  const hideDates    = document.getElementById("yogHideDates")?.checked;
  const hideMonthDay = document.getElementById("yogHideMonthDay")?.checked;
  const hideAge      = document.getElementById("yogHideAge")?.checked;
  const hideAgeMD    = document.getElementById("yogHideAgeMD")?.checked;

    function fmt(d){
    if(
      COSMETIC_BIRTHDATE &&
      n.level === 1 &&
      birthDate.value &&
      d < new Date(birthDate.value)
    ){
      d = new Date(birthDate.value);
    }

    if(hideMonthDay) return d.getFullYear();
    if(hideDates)
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    return d.toISOString().slice(0,10);
  }








   function yogAge(d){

  if(document.getElementById("yogHideAge")?.checked){
    return "";
  }

  // Cosmetic birthdate (display only)
  d = cosmeticStartDate(d);

  const birth = new Date(birthDate.value);

  return ` (${diffYMD_YOGINI(birth, d)})`;
}










  h.innerHTML =
  `${levelPrefix(n.level,n.start,n.end)}` +
  `<b>${T(n.name)} { ${T(n.lord)} }</b> ` +
  `${fmt(n.start)}${yogAge(n.start)} ‚Üí‚Üí‚Üí‚Üí ${fmt(n.end)}${yogAge(n.end)}`;


  let c = document.createElement("div");
  c.style.display = "none";
  n.children.forEach(ch => c.appendChild(renderYoginiNode(ch)));

  h.onclick = () => {
    w.classList.toggle("active");
    c.style.display = w.classList.contains("active") ? "block" : "none";
  };

  w.appendChild(h);
  w.appendChild(c);
  return w;
}








function findYoginiAnalyzer(){

    const val = document.getElementById("yoginiAnalyzerDate").value;
  if(!val) return;

  const d = new Date(val);

  document
    .querySelectorAll("#yoginiTree .active")
    .forEach(a=>a.classList.remove("active"));

  document
    .querySelectorAll("#yoginiTree .dasha-node > div:nth-child(2)")
    .forEach(d=>d.style.display="none");

  const nodes = [...document.querySelectorAll("#yoginiTree .dasha-node")]
    .filter(n =>
      d >= new Date(n.dataset.s) &&
      d <  new Date(n.dataset.e)
    )
    .sort((a,b)=>a.dataset.l - b.dataset.l);

  nodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });


}










</script>


<script>
/* =========================================
   YOGINI EVENT ANALYZER (SINGLE EVENT)
   ========================================= */

function setYoginiToday(){
  document.getElementById("yoginiEventDate").value =
    new Date().toISOString().slice(0,10);
}

function findYoginiEvent(){

  const out = document.getElementById("yoginiEventResult");
  const val = document.getElementById("yoginiEventDate").value;
  if(!val) return;

  const d = new Date(val);

  document
    .querySelectorAll("#yoginiTree .active")
    .forEach(a=>a.classList.remove("active"));

  document
    .querySelectorAll("#yoginiTree .dasha-node > div:nth-child(2)")
    .forEach(d=>d.style.display="none");

  const nodes = [...document.querySelectorAll("#yoginiTree .dasha-node")]
    .filter(n => d >= new Date(n.dataset?.s || n.__start) &&
                 d <  new Date(n.dataset?.e || n.__end))
    .sort((a,b)=>a.classList.contains("level-1")?-1:1);

  nodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  out.textContent = nodes
    .map(n=>n.querySelector("b").textContent)
    .join(" ‚Üí ");
}






/* =====================================================
   SAFE AUTO-REFRESH (NO EVENT OVERRIDES)
   ===================================================== */
function autoRefreshAll(){
  if(!birthDate.value) return;

  generate();
  rebuildComparator();
  buildYogini();
  rebuildYoginiComparator();
  updateNativeAge();

  /* ===============================
     FORCE BUILD: VIMSHOTTARI + YOGINI
     (NO USER INTERACTION REQUIRED)
     =============================== */

  if(BODY_DEGREE_MAP){

    // set defaults only if empty
    if(vyVimAnchor && !vyVimAnchor.value){
      vyVimAnchor.value = "Chandra";
    }
    if(vyYogAnchor && !vyYogAnchor.value){
      vyYogAnchor.value = "Chandra";
    }

    // üî• ALWAYS BUILD ‚Äî this was missing
    buildVYVimTree();
    buildVYYogTree();
  }

  fillAllCurrentTransitDates();
}










function genYoginiCompareLevel(level,start,yogini,yrs){
  if(level > +yoginiShowTill.value) return [];

  let arr = [];
  let cur = new Date(start);

  const startIndex = YOGINI_ORDER.findIndex(y => y.name === yogini.name);
  const rotated = [
    ...YOGINI_ORDER.slice(startIndex),
    ...YOGINI_ORDER.slice(0, startIndex)
  ];

  rotated.forEach(y => {
    let len = yrs * (y.years / 36);
    let end = addYears(cur, len);

    arr.push({
      level,
      name: y.name,
      lord: y.lord,
      start: new Date(cur),
      end: new Date(end),
      children: genYoginiCompareLevel(level + 1, cur, y, len)
    });

    cur = end;
  });

  return arr;
}









/* =====================================================
   VIMSHOTTARI + YOGINI COMBINED COMPARATOR
   ===================================================== */

function setVYToday(){
  document.getElementById("vyEventDate").value =
    new Date().toISOString().slice(0,10);
}










function buildVYVimTree(){
  if(!birthDate.value || !BODY_DEGREE_MAP) return;

  vyVimTree.innerHTML = "";

  const anchor = vyVimAnchor.value;
  const deg = BODY_DEGREE_MAP[anchor];
  if(deg == null) return;

  const lord = nakLord(deg);
  const elapsed = dashaElapsedYears(deg);

  let start = new Date(birthDate.value);
  start = new Date(start.getTime() - elapsed * MS_YEAR);

  rotate(lord).forEach(p=>{
    let end = addYears(start, YEARS[p]);

    const node = renderCompareNode({
      level:1,
      planet:p,
      start:new Date(start),
      end:new Date(end),
      children:genCompareLevel(2,start,p,YEARS[p],+showTill.value)
    });

    /* üîí DEFAULT STATE ‚Äî FULLY COLLAPSED (LIKE OTHER TABLES) */
    node.querySelectorAll(".dasha-node > div:nth-child(2)")
        .forEach(d => d.style.display = "none");
    node.querySelectorAll(".dasha-node")
        .forEach(n => n.classList.remove("active"));

    vyVimTree.appendChild(node);
    start = end;
  });
}









function renderYoginiCompareNode(n){

  let w = document.createElement("div");
  w.className = "dasha-node yogini level-" + n.level;

  w.dataset.s = n.start;
  w.dataset.e = n.end;
  w.dataset.l = n.level;

  let h = document.createElement("div");
  h.className = "dasha-header";

  function fmt(d){

    d = cosmeticStartDate(d);

    if(document.getElementById("yogCmpHideMonthDay")?.checked){
      return d.getFullYear();
    }

    if(document.getElementById("yogCmpHideDates")?.checked){
      return d.getFullYear() + "-" +
        String(d.getMonth()+1).padStart(2,"0");
    }

    return d.toISOString().slice(0,10);
  }

  let startAge = "";
  let endAge   = "";

  if(!document.getElementById("yogCmpHideAge")?.checked){
    const birth = new Date(birthDate.value);
    startAge = ` (${Math.floor((n.start - birth) / MS_YEAR)} ${T("years")})`;
    endAge = ` (${Math.floor((n.end - birth) / MS_YEAR)} ${T("years")})`;

  }

  h.innerHTML =
    `${levelPrefix(n.level,n.start,n.end)}` +
    `<b>${T(n.name)} { ${T(n.lord)} }</b> | ` +
    `${fmt(n.start)}${startAge} ‚Üí ${fmt(n.end)}${endAge}`;

  let c = document.createElement("div");
  c.style.display = "none";
  n.children.forEach(ch => c.appendChild(renderYoginiCompareNode(ch)));

  h.onclick = () => {
    w.classList.toggle("active");
    c.style.display = w.classList.contains("active") ? "block" : "none";
  };

  w.appendChild(h);
  w.appendChild(c);
  return w;
}































function buildVYYogTree(){
  if(!birthDate.value || !BODY_DEGREE_MAP) return;

  vyYogTree.innerHTML = "";

  const anchor = vyYogAnchor.value;
  const deg = BODY_DEGREE_MAP[anchor];
  if(deg == null) return;

  let nak = Math.floor(deg / 13.3333333333) + 1;
  let idx = (nak + 3) % 8;
  if(idx === 0) idx = 8;
  idx--;

  const birth = new Date(birthDate.value);
  const first = YOGINI_ORDER[idx];

  const nakStart = (nak - 1) * 13.3333333333;
  let elapsedDeg = deg - nakStart;
  if(elapsedDeg < 0) elapsedDeg += 360;

  let elapsedYears =
    (elapsedDeg / 13.3333333333) * first.years;

  let cur = new Date(birth.getTime() - elapsedYears * MS_YEAR);

  for(let cycle=0; cycle<3; cycle++){
    for(let i=0;i<8;i++){
      let y = YOGINI_ORDER[(idx + i) % 8];
      let end = addYears(cur, y.years);

      const node = renderYoginiCompareNode({
        level:1,
        name:y.name,
        lord:y.lord,
        start:new Date(cur),
        end:new Date(end),
        years:y.years,
        children:genYoginiCompareLevel(2,cur,y,y.years)
      });

      /* üîí DEFAULT STATE ‚Äî FULLY COLLAPSED */
      node.querySelectorAll(".dasha-node > div:nth-child(2)")
          .forEach(d => d.style.display = "none");
      node.querySelectorAll(".dasha-node")
          .forEach(n => n.classList.remove("active"));

      vyYogTree.appendChild(node);
      cur = end;
    }
  }
}












function findVYTransit(){

  const val = vyEventDate.value;
  if(!val) return;
  const d = new Date(val);

  // clear previous
  document
    .querySelectorAll("#vyCompareWrap .active")
    .forEach(a=>a.classList.remove("active"));

  document
    .querySelectorAll("#vyCompareWrap .dasha-node > div:nth-child(2)")
    .forEach(n=>n.style.display="none");

  // Vimshottari
  const vimNodes = [...vyVimTree.querySelectorAll(".dasha-node")]
    .filter(n => d >= new Date(n.dataset.s) && d < new Date(n.dataset.e))
    .sort((a,b)=>a.dataset.l - b.dataset.l);

  vimNodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  // Yogini
  const yogNodes = [...vyYogTree.querySelectorAll(".dasha-node")]
    .filter(n => d >= new Date(n.dataset.s) && d < new Date(n.dataset.e))
    .sort((a,b)=>a.dataset.l - b.dataset.l);

  yogNodes.forEach(n=>{
    n.classList.add("active");
    if(n.children[1]) n.children[1].style.display="block";
  });

  vyEventResult.textContent =
    "Vimshottari: " +
    vimNodes.map(n=>n.querySelector("b").textContent.split(" ‚Äì ").pop()).join(" ‚Üí ")
    +
    " | Yogini: " +
    yogNodes.map(n=>n.querySelector("b").textContent).join(" ‚Üí ");
}

</script>



<script>


















/* Fill on first load */
document.addEventListener("DOMContentLoaded", fillAllCurrentTransitDates);


/* Fill after Clear All */
const _oldClearAll = clearAll;
clearAll = function(){
  _oldClearAll();
  setTimeout(()=>{
    fillAllCurrentTransitDates();
    if(birthDate.value && BODY_DEGREE_MAP){
      autoRefreshAll();
    }
  },0);
};
</script>




<script>

birthDate.addEventListener("change", autoRefreshAll);
startPlanet.addEventListener("change", autoRefreshAll);
showTill.addEventListener("change", autoRefreshAll);
repeatCycle.addEventListener("change", autoRefreshAll);

yoginiPivot.addEventListener("change", autoRefreshAll);
yoginiShowTill.addEventListener("change", autoRefreshAll);

compareLeftAnchor.addEventListener("change", autoRefreshAll);
compareRightAnchor.addEventListener("change", autoRefreshAll);
yogCompareLeftAnchor.addEventListener("change", autoRefreshAll);
yogCompareRightAnchor.addEventListener("change", autoRefreshAll);





</script>















</body>
</html>


